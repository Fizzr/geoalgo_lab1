<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <canvas id="myCanvas" width="800" height="600" style="border:1px solid #000000;"></canvas>

    <br>
    <button id="random" class="menu">Random</button>
    <button id="compute" class="menu">Compute</button>
    <button id="clear" class="menu">Clear</button>
    <input id="input" type="file" accept=".txt" hidden="hidden">
    <label for="input" class="menu">Load</label>
    <button id="coords" class="menu">Coords</button>
    <div>
        <div style="float:left">
            <br>
            A:
            x<input  id ="ax" type="number" class="coord">
            y<input  id ="ay" type="number" class="coord">
            <br>
            B:
            x<input  id ="bx" type="number" class="coord">
            y<input  id ="by" type="number" class="coord">
            <br>
            C:
            x<input  id ="cx" type="number" class="coord">
            y<input  id ="cy" type="number" class="coord">
            <br>
            Upper hull <input id = "turnType" type="checkbox">
        </div>
        <button id="turn" class="menu" style="float:left; margin-top: 40px; margin-left: 10px">Test Turn</button>
        <div id="turnRes" style="float:left; margin-top: 40px; margin-left: 10px"> </div>
    </div>
    <script>
        var $canvas = $("#myCanvas");
        var canvas = $canvas[0];
        var c = canvas.getContext("2d");
        var pointList = [];
        var circleSize = 5;
        c.fillStyle = "#CA1337"



        function addPoint (x, y)
        {
            var invertedY = canvas.height -y;
            pointList.push([x,y]);
            c.strokeStyle = "#000000";
            c.beginPath();
            c.arc(x,invertedY, circleSize, 0, 2*Math.PI, false);
            c.fill();
            c.stroke();
        }

        $canvas.click(function(e)
        {
            var xCord = e.pageX - canvas.offsetLeft;
            var yCord = e.pageY - canvas.offsetTop;
            addPoint(xCord, canvas.height - yCord);
        });

        $("#clear").click(function()
        {
            pointList.length = 0;
            c.clearRect(0,0, canvas.width, canvas.height);
        });

        $("#turn").click(function()
        {
            var ax = $("#ax").val();
            var ay = $("#ay").val();
            var bx = $("#bx").val();
            var by = $("#by").val();
            var cx = $("#cx").val();
            var cy = $("#cy").val();
            var check = $("#turnType")[0].checked;

            if (!(ax == "" || ay == "" || bx == "" || by == "" || cx == "" || cy == ""))
            {
                var a = [ax, ay];
                var b =[bx, by];
                var c = [cx, cy];
                if(a[0] == b[0])
                    a[0] = a[0] + 0.000001;
                var koef = (a[1] - b[1]) / (a[0] - b[0]);
                var con = (-a[0] * koef) + a[1];
                var resY = cx * koef + con;

                console.log( cy + " vs " + resY);

                $("#turnRes").text(isRightTurn([ax, ay], [bx, by], [cx, cy], check));
            }
            else
            {
                $("#turnRes").text("Missing Coordinates")
            }
        });

        $("#coords").click(function()
        {
            for(var i = 0; i < pointList.length; i++)
            {
                c.strokeStyle = "#000000";
                c.strokeText(pointList[i][0] + " : " + pointList[i][1], pointList[i][0], canvas.height - pointList[i][1] - 20);
            }
        });

        $("#input").change(function()
        {
            var file = this.files[0];
            $(this).val("");
            var reader = new FileReader();

            reader.onload = function(e)
            {
                var text = reader.result;
                var lines = text.split(/[\r\n]+/g);

                for (var i = 0; i < lines.length; i++)
                {
                    coords = lines[i].split(" ");
                    if(coords.length != 2 || isNaN(coords[0]) || isNaN(coords[1]))
                    {
                        alert("Error reading file on line "+ i);
                        return;
                    }
                    addPoint(parseInt(coords[0]), parseInt(coords[1]));
                }
            };
            reader.readAsText(file);
        });

        $("#random").click(function (e)
        {
            var num = Math.random()*40+5;

            for(var i = 0; i < num; i++)
            {
                var x = Math.floor(Math.random()*canvas.width);
                var y = Math.floor(Math.random()*canvas.height);
                addPoint(x,y);
            }
        })

        $("#compute").click(function()
        {
            var res = Andrew();
            console.log("Result:");
            for (var i = 0; i < res.length; i++)
            {
                console.log(res[i][0] + " " + res[i][1]);
            }
        });

        function isRightTurn(a, b, c, goingRight)
        {
            if(a[0] == b[0])
            {
                //a[0] += 0.000001;
            }
            var koef = (a[1] - b[1]) / (a[0] - b[0]);
            var con = (-a[0] * koef) + a[1];

            if (c[1] < koef * c[0] + con)
            {
                if(goingRight)
                    return true;
                else
                    return false;
            }
            else
            {
                if(goingRight)
                    return false;
                else
                    return true;
            }

        }

        function Andrew ()
        {
            pointList.sort(function (a, b)
            {
                if(a[0] == b[0])
                    return a[1] - b[1];
                return a[0] - b[0];         //Sort by x coordinate (index 0)
            })

            var upperHull = [];
            var lowerHull = [];
            var onlyOne = false;
            var i = 0;
            var right = true;
            var change = 1;
            var hull = upperHull;

            for (var p = 0; p < 2; p++)
            {
                while ((i < pointList.length && right) || (i >= 0 && !right))
                {
                    if (hull.length >= 2)
                    {
                        var a = hull[hull.length - 2];
                        var b = hull[hull.length - 1];

                        while (!onlyOne && !isRightTurn(a, b, pointList[i], right))
                        {
                            hull.pop()
                            if(!(!right && b == upperHull[upperHull.length-2] && i == pointList.length-3))
                            {
                                c.beginPath();
                                c.strokeStyle = "#3dff94";
                                c.moveTo(a[0], canvas.height - a[1]);
                                c.lineTo(b[0], canvas.height - b[1]);
                                c.stroke();
                            }
                            if (hull.length > 1)
                            {
                                a = hull[hull.length - 2];
                                b = hull[hull.length - 1];
                            }
                            else
                            {
                                onlyOne = true;
                            }
                        }
                    }
                    hull.push(pointList[i])
                    if (hull.length > 1)
                    {
                        onlyOne = false;
                        c.beginPath();
                        c.strokeStyle = "#FF0000";
                        c.moveTo(hull[hull.length - 1][0], canvas.height - hull[hull.length - 1][1]);
                        c.lineTo(hull[hull.length - 2][0], canvas.height - hull[hull.length - 2][1]);
                        c.stroke();
                    }
                    i = i + change;
                }
                i--;
                change = -1;
                right = false;
                hull = lowerHull;
            }

            return upperHull.concat(lowerHull.slice(1, lowerHull.length-1));
        }
    </script>
</html>